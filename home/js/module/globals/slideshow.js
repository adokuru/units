define(["jquery","modernizr"],function(i){"use strict";return i.fn.slideshow=function(t){function e(t,e,s,n){this.imgs=e,this.elms=s,this.capt=n,this.content=[],this.index=-1,this.options=t,this.mv=!1,this.overlay=i("<div/>").addClass(this.options.clsOverlay).hide(),this.wrapper=i("<div/>").addClass(this.options.clsWrapper).appendTo(this.overlay),this.inner=i("<div/>").addClass(this.options.clsInner).appendTo(this.wrapper),this.caption=i('<div class="caption-inner"></div>'),this.showCaption=!1,this.wrapper.append(i('<div class="slideshow-caption"><a href="#" class="caption-close icon-cancel" aria-label="Hide caption"></a></div>').append(this.caption)),this.nav={prev:i('<div class="slideshow-prev"><i class="icon-angle-left"></i></div>').appendTo(this.wrapper),next:i('<div class="slideshow-next"><i class="icon-angle-right"></i></div>').appendTo(this.wrapper),bar:i('<div class="slideshow-nav"><div class="slides"></div></div><a href="#" aria-label="Toggle caption" class="slideshow-togglecaption icon-align-left'+(this.showCaption?" active":"")+'"></a><a href="#" aria-label="Close" class="slideshow-close icon-cancel"></a>').appendTo(this.wrapper)},r&&this.imgs.length>1&&a.call(this),this.imgs.length<=1&&(this.options.showArrows=!1),this.options.showArrows?this.nav.prev.add(this.nav.next).on("mouseenter",function(){i(this).find("i").fadeTo(t.animDuration,1)}).on("mouseleave",function(){i(this).find("i").fadeTo(t.animDuration,.5)}):this.nav.prev.add(this.nav.next).find("i").remove(),this.nav.prev.add(this.nav.next).show(),this.nav.prev.on("click",i.proxy(function(i){i.preventDefault(),this.prev()},this)),this.nav.next.on("click",i.proxy(function(i){i.preventDefault(),this.next()},this)),this.wrapper.on("click",".caption-close, .slideshow-togglecaption",i.proxy(function(i){i.preventDefault(),i.stopPropagation();var t=this.nav.bar.filter(".slideshow-togglecaption");this.showCaption=!this.showCaption,this.showCaption?(t.addClass("active"),this.capt[this.index]&&this.caption.parent().fadeIn(this.options.animDuration)):(t.removeClass("active"),this.caption.parent().fadeOut(this.options.animDuration))},this)).on("click",".slideshow-close",i.proxy(function(i){i.preventDefault(),this.close()},this)),o(this.options.loadingImg),i(i.proxy(function(){i("body").append(this.overlay)},this));for(var h=i.proxy(function(t){t.preventDefault();var e=i(t.currentTarget).data("slideshow");e&&void 0!==e.index&&this.open(e.index,e.showCaption)},this),d=0;d<this.elms.length;d++)this.elms[d].data("slideshow",{index:d,showCaption:s[d].data("captionActive")?1:0}).addClass(this.options.clsActive),!1!==this.elms[d].data("slideshowTrigger")&&this.elms[d].not(".no-slideshow-trigger").off("click.slideshow").on("click.slideshow",h)}function s(i,t,e){var s=t.width(),n=t.height(),o=0,a=!1,r=!1;i.parent().is(":visible")||(r=!0,i.parent().show().css("visibility","hidden")),e&&(o=e.outerHeight(),a=0===parseInt(e.css("top"),10)),i.height(n).width("auto"),i.width()>s&&i.width(s).height("auto"),i.css({left:s/2-i.width()/2+"px",top:(a?o:n/2-i.height()/2)+"px"}),r&&i.parent().hide().css("visibility","")}function n(i,t,e){var s=t.width(),n=t.height(),o=0,a=!1;e&&(o=e.outerHeight(),a=0===parseInt(e.css("top"),10));var r,h,d=n-2*o,l=s-(a?0:128),p=i.prop("width")/i.prop("height");l/p>d?(h=d,r=h*p):(r=l,h=r/p),i.width(r).height(h).css({left:s/2-i.width()/2+"px",top:(a?o:n/2-i.height()/2)+"px"})}function o(t,e,s){var n=document.createElement("img");return n.src=t,i(n).css({visibility:"hidden",position:"absolute",zIndex:"-1000"}),setTimeout(function(){n.complete||4==n.readyState?(i(n).css({visibility:"",position:"",zIndex:""}),"function"==typeof e&&e.call(n,n)):i(n).on("load error onreadystatechange",function(t){i(n).css({visibility:"",position:"",zIndex:""}),"error"==t.type&&"function"==typeof s?s.call(n,n):"function"==typeof e&&e.call(n,n)})},0),n}function a(t){t||(t=this.wrapper);var e={x:0,y:0},s={},n=!1,o=!1,a=function(i){if(n)return!0;var t=i.originalEvent.touches[0]||i.originalEvent.changedTouches[0];e={x:t.pageX,y:t.pageY},this.mv=!1},r=function(t){if(n||o)return!0;var a=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0];if(!this.mv)if(a.pageX<e.x-5||a.pageX>e.x+5){this.mv=!0,s.current=this.content[this.index].css("z-index",1);var r=s.current.width();r<=0&&(r=i(window).width()),s.current.width(r),s.prev=this.load(this.prev(!0)).css("left",-r+"px"),s.next=this.load(this.next(!0)).css("left",r+"px"),s.all=s.current.add(s.prev).add(s.next),s.prev.add(s.next).css({top:0,width:r+"px",zIndex:2}).show().fadeTo(0,1)}else{if(a.pageY<e.y-5||a.pageY>e.y+5)return o=!0,!0;t.preventDefault()}if(this.mv){t.preventDefault();var l=a.pageX-e.x;for(var p in h)h.hasOwnProperty(p)&&s.all.css(h[p],d?"translate3d("+l+"px,0,0)":"translate("+l+"px,0)")}},l=function(t){if(o=!1,n||!this.mv)return!0;var a=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0],r=a.pageX-e.x,l=Math.abs(r),p=s.current.width(),c=s.current,f=0,v=1.5*this.options.animDuration*l/p,u=this.index;Math.abs(r)>=p/3&&(u=r>0?this.prev(!0,!0):this.next(!0,!0),c=r>0?s.prev:s.next,f=r>0?p:-p,v=1.5*this.options.animDuration*(p-l)/p),n=!0,i({a:r}).animate({a:f},{duration:v,step:function(i){for(var t in h)h.hasOwnProperty(t)&&s.all.css(h[t],d?"translate3d("+i+"px,0,0)":"translate("+i+"px,0)")},complete:i.proxy(function(){s.all.not(c).hide(),c.show();for(var t in h)h.hasOwnProperty(t)&&s.all.css(h[t],d?"translateZ(0)":"");s.all.css({width:"",height:"",left:"",top:""}),this.index=u,this.show(this.index),setTimeout(i.proxy(function(){this.mv=!1,n=!1},this),0)},this)})};t.on("touchstart",i.proxy(a,this)).on("touchmove",i.proxy(r,this)).on("touchend touchcancel",i.proxy(l,this))}var r=window.Modernizr?window.Modernizr.touchevents:"ontouchstart"in window,h={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"},d=function(){var i,t=document.createElement("p"),e={};document.body.insertBefore(t,null);for(var s in h)void 0!==t.style[s]&&(e[s]=h[s],t.style[s]="translate3d(1px,1px,1px)",i=window.getComputedStyle(t).getPropertyValue(h[s]));return document.body.removeChild(t),h=e,void 0!==i&&i.length>0&&"none"!==i}(),l={clsActive:"slideshow-active",clsOverlay:"slideshow-overlay",clsWrapper:"slideshow-wrapper",clsInner:"slideshow-inner",clsInnerContent:"slideshow-inner-content",loadingImg:"/images/ajax-loader-b.gif",errorMsg:"The requested content cannot be loaded.<br/>Please try again later.",animDuration:250,showArrows:!0};e.prototype.open=function(t,e){t||(t=0),this.sc=i(window).scrollTop(),i("html, body").css({width:"100%",height:"100%",overflow:"hidden",margin:0,padding:0}),this.inner.children().hide(),this.overlay.show(),i(window).scrollTop(1),i(window).scrollTop(0),i(document).off(".slideshow").on("keydown.slideshow",i.proxy(function(i){if(40==i.keyCode||38==i.keyCode||32==i.keyCode)return i.preventDefault(),!1;27==i.keyCode?this.close():37==i.keyCode?this.prev():39==i.keyCode&&this.next()},this)),i(window).off(".slideshow").on("resize.slideshow scroll.slideshow",i.proxy(function(){this.inner.find("img").each(i.proxy(function(t,e){s(i(e),this.inner,this.nav.bar)},this)),this.inner.find("iframe,video").each(i.proxy(function(t,e){n(i(e),this.inner,this.nav.bar)},this))},this)),this.show(t,e)},e.prototype.show=function(t,e){if(!(t<0||t>this.imgs.length-1)){if(t!==this.index){var s=this.load(t);this.inner.children().filter(":visible").not(s).css("z-index",1).stop(!0,!0).fadeOut(this.options.animDuration),this.pauseVideos(),s.css("z-index",2).stop(!0,!0).fadeIn(this.options.animDuration)}this.caption.empty();var n=this.nav.bar.filter(".slideshow-togglecaption"),o=!1;if(this.capt[t]){var a=this.capt[t],r=i([]);a.text&&(r=r.add(i("<div/>").html(a.text))),a.credits&&(r=r.add(i("<small/>").text("Credits: "+a.credits))),this.caption.empty().append(r),this.showCaption?this.caption.parent().fadeIn(this.options.animDuration):this.caption.parent().hide(),n.show(),o=e&&!n.hasClass("active")}else this.caption.parent().hide(),n.hide();this.index=1*t,this.nav.bar.find(".slides").text(1*t+1+" of "+this.imgs.length),i(window).trigger("resize"),o&&n.click()}},e.prototype.load=function(t){if(!(t<0||t>this.imgs.length-1)){var e=this.content[t]||!1;if(!e||e.hasClass("error")||r&&e.hasClass("iframe")){e&&e.remove(),e=i("<div/>").addClass(this.options.clsInnerContent).addClass("loadingimg").hide();var a=this.elms[t].filter("iframe,video");if(a.size()){var h=a.first().clone().prop({id:""});if(h.data("ar")){var d=h.data("ar").split(":");2==d.length&&h.prop({width:10*d[0],height:10*d[1]})}else h.prop({width:this.elms[t].width(),height:this.elms[t].height()});e.addClass("iframe").append(h.css("position","absolute").show()),n(i(h),this.inner,this.nav.bar)}else{var l=o(this.imgs[t],i.proxy(function(t){e.removeClass("loadingimg"),s(i(t).fadeIn(this.options.animDuration),this.inner,this.nav.bar)},this),i.proxy(function(){e.removeClass("loadingimg").addClass("error").append(i('<div class="error"></div>').html(this.options.errorMsg))},this));e.append(i(l).hide())}this.inner.append(e),this.content[t]=e}return e}},e.prototype.close=function(){this.pauseVideos(),i("html, body").css({width:"",height:"",overflow:"",margin:"",padding:""}),i(window).off(".slideshow").trigger("resize").scrollTop(this.sc),i(document).off(".slideshow"),this.overlay.hide(),this.caption.empty().parent().hide(),this.index=-1},e.prototype.prev=function(i,t){var e=this.index-1;return e<0&&(e=this.imgs.length-1),i||this.mv||this.show(e),t&&this.pauseVideos(),e},e.prototype.next=function(i,t){var e=this.index+1;return e>this.imgs.length-1&&(e=0),i||this.mv||this.show(e),t&&this.pauseVideos(),e},e.prototype.pauseVideos=function(){this.inner.find("iframe").each(function(){this.contentWindow.postMessage('{"event":"command","func":"pauseVideo"}',"*"),this.contentWindow.postMessage('{"method":"pause"}',"*")}),this.inner.find("video").each(function(){this.pause()})},e.prototype.resetVideos=function(){this.inner.find("iframe").each(function(){var t=i(this).parent().html();i(this).parent().html(t)})};var p=function(){if(window.Modernizr.mq("(max-width: 508px)")&&window.Modernizr.touchevents)return!0},c=function(){if(window.Modernizr.mq("(max-width: 768px)")&&window.Modernizr.touchevents)return!0},f=[],v=[],u=[],w=[];if(i(this).each(function(){var t,e=i(this),s=e.data("slideshow"),n=e.data("slideshow-mobile"),o=e.data("slideshow-tablet");if(e.hasClass("slideshow-active")||i.isPlainObject(s))return!0;if("VIDEO"==e.prop("tagName")&&(s="video:"+e.data("id")),s||(s=e.data("original")),s||(s=e.attr("src")),s||(s=e.attr("href")),!s)return!0;if((p()||c())&&(i("<img/>")[0].src=s),(t=i.inArray(s,w))<0){w.push(s),f.push(p()&&n?n:c()&&o?o:s),v.push(e);var a=e.data("caption"),r=e.data("credits");a||r?u.push({text:decodeURIComponent(a.replace(/%(?![\da-f]{2})/gi,function(){return"%25"})),credits:r}):u.push(!1)}else v[t]=v[t].add(e)}),f.length){window.slideshow||(window.slideshow=[]);var m=new e(i.extend(l,t),f,v,u);if(window.slideshow.push(m),t&&t.ret&&"object"==t.ret)return m}return this},i.slideshow={close:function(){window.slideshow&&i.each(window.slideshow,function(){this.close()})}},{start:function(t){t||(t=i("body")),t.each(function(){var e,s=".slideshow, [data-slideshow], figure.video iframe, .hero-video iframe, .hero-video video",n=i(".detail-hero-image",t);if(n.size()){var o=n.find(s).toArray(),a=i(s,t).not(o).toArray();e=i(o.concat(a)).not(".no-hero-slideshow")}else e=i(s,t).not(".no-hero-slideshow");var r={__default:[]};e.each(function(t,e){var s=i(e).data("slideshowId");s?(r[s]||(r[s]=[]),r[s].push(e)):r.__default.push(e)}),i.each(r,function(t,e){i(e).slideshow({id:t})})})}}});